<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compose Stack Dashboard</title>
  <style>
    :root{
      --bg: #0f1115;
      --panel: #171a21;
      --text: #e7eaf0;
      --muted: #a8b0c0;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;

      --ok: #48d18f;
      --warn: #ffd166;
      --bad: #ff5c7a;
      --accent: #7aa2ff;
      --accent2: #9bdbff;

      --chip: rgba(122,162,255,0.12);
      --chip-border: rgba(122,162,255,0.25);
    }

    * { box-sizing: border-box; }
    html, body { width: 100%; overflow-x: hidden; }

    body{
      margin: 0;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,0.18), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(155,219,255,0.12), transparent 55%),
        var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    }

    .wrap{
      width: 100%;
      max-width: 2000px;
      margin: 0 auto;
      padding: 14px;
    }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .brand{ display:flex; align-items:center; gap: 10px; }
    .logo{
      width: 34px; height: 34px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(155,219,255,0.95));
      box-shadow: 0 10px 25px rgba(122,162,255,0.25);
      display:grid; place-items:center;
      color: #0b0d12;
      font-weight: 900;
      font-size: 13px;
      flex: 0 0 auto;
    }

    h1{ font-size: 15px; margin: 0; letter-spacing: 0.2px; }
    .subtitle{ margin: 0; color: var(--muted); font-size: 12px; }

    .toolbar{
      display:flex; gap: 8px; align-items:center; flex-wrap: wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    button{
      appearance:none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
      transition: transform 0.08s ease, border-color 0.2s ease;
      font-weight: 700;
      font-size: 13px;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,0.35); }
    button:active{ transform: translateY(0px); }

    select, input{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
      max-width: 100%;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(260px, 35vw, 400px), 1fr));
      gap: 12px;
      width: 100%;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-width: 0;
       container-type: inline-size;   /* enables @container queries */
  container-name: stackcard;
    }
    .cardHeader{
      padding: 10px 10px 6px 10px;
      display:flex; justify-content:space-between; gap: 10px; align-items:flex-start;
    }

    .stackTitle{ display:flex; flex-direction:column; gap: 6px; min-width: 0; }
    .stackName{ display:flex; align-items:center; gap: 8px; min-width: 0; }

    .stackName strong{
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      letter-spacing: 0.2px;
      max-width: 100%;
    }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--chip-border);
      color: var(--accent2);
      font-size: 12px;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .cardBody{
      padding: 8px 10px 10px 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    /* Compact gauge row: two mini blocks side-by-side */
    .gaugesInline{
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap: 8px;
      min-width: 0;
      width: 100%;
    }

    .gaugeMini{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(12,14,18,0.45);
      border: 1px solid rgba(255,255,255,0.06);
      flex: 1;
      overflow: hidden;
    }

    .gaugeMini .txt{ display:flex; flex-direction:column; gap: 2px; min-width: 0; }
    .gaugeMini .txt .k{
      font-size: 12px; color: var(--muted); font-weight: 700; letter-spacing: 0.02em;
    }
.gaugeMini .txt .v{
  font-size: 13px;
  font-weight: 900;
  white-space: nowrap;
  overflow: visible;
  text-overflow: unset;
}

    /* Compact metrics row */
    .ioGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      min-width: 0;
      width: 100%;
    }

    .metric{
      padding: 8px 8px;
      border-radius: 14px;
      background: rgba(12,14,18,0.45);
      border: 1px solid rgba(255,255,255,0.06);
      min-width: 0;
      overflow: hidden;
    }
    .metric .k{ font-size: 12px; color: var(--muted); font-weight: 700; }
    .metric .v{
      margin-top: 6px;
      font-weight: 900;
      font-size: 13px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,0.06);
      margin: 0 10px;
    }

    /* Expandable container list */
    .expandToggle{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      padding: 9px 10px;
    }
    .expandToggle:hover{ color: var(--text); }

    .chevron{ transition: transform 0.2s ease; }

    .card.expanded .chevron{ transform: rotate(90deg); }

    .containerSection{
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s ease, opacity 0.25s ease;
      opacity: 0;
    }
    .card.expanded .containerSection{
      max-height: 1400px;
      opacity: 1;
    }

    .tableWrap{ padding: 8px 10px 10px 10px; }
    table{ width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td{
      padding: 7px 8px;
      border-top: 1px solid rgba(255,255,255,0.06);
      vertical-align: middle;
    }
    th{
      color: var(--muted);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(231,234,240,0.92);
    }
    .right{ text-align: right; }

    .statusDot{
      display:inline-block; width: 8px; height: 8px; border-radius: 50%;
      margin-right: 8px; vertical-align: middle;
      background: rgba(255,255,255,0.2);
    }
    .running{ background: var(--ok); box-shadow: 0 0 0 3px rgba(72,209,143,0.15); }
    .stopped{ background: rgba(255,255,255,0.28); }
    .restarting{ background: var(--warn); box-shadow: 0 0 0 3px rgba(255,209,102,0.14); }

    .empty{
      padding: 14px;
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,0.14);
      border-radius: var(--radius);
      text-align:center;
    }

    @media (max-width: 520px){
      .gaugesInline{ flex-direction: row; }
    }
    /* Default table spacing (normal) */
.tableWrap th, .tableWrap td { padding: 7px 8px; }
.tableWrap th { font-size: 11px; }
.tableWrap td { font-size: 13px; }

/* When the CARD is narrow, make the container list compact */
@container stackcard (max-width: 330px) {
  .tableWrap { padding: 6px 8px 8px 8px; }
  .tableWrap th, .tableWrap td { padding: 6px 6px; }
  .tableWrap th { font-size: 10px; }
  .tableWrap td { font-size: 12px; }

  /* Hide less important columns first */
  .col-service { display: none; }
}

/* Even narrower: hide CPU too */
@container stackcard (max-width: 290px) {
  .col-cpu { display: none; }
}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CD</div>
        <div>
          <h1>Compose Dashboard</h1>
          <p class="subtitle">Stacks (Compose projects) · gauges · restart</p>
        </div>
      </div>

      <div class="toolbar">
        <div class="pill" id="statusPill">Loading…</div>
        <input id="filter" placeholder="Filter stacks…" />
        <select id="autoRefresh">
          <option value="0">Auto: off</option>
          <option value="2">Auto: 2s</option>
          <option value="5" selected>Auto: 5s</option>
          <option value="10">Auto: 10s</option>
        </select>
        <button id="refreshBtn">Refresh</button>
      </div>
    </header>

    <div class="grid" id="grid"></div>
  </div>

<script>
  const grid = document.getElementById('grid');
  const statusPill = document.getElementById('statusPill');
  const refreshBtn = document.getElementById('refreshBtn');
  const autoRefresh = document.getElementById('autoRefresh');
  const filterEl = document.getElementById('filter');

  let lastStacks = [];

  // Persist expanded cards across refreshes
  const EXP_KEY = 'composeDashboard.expandedStacks';

  function loadExpandedSet(){
    try {
      const raw = localStorage.getItem(EXP_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return new Set(Array.isArray(arr) ? arr : []);
    } catch {
      return new Set();
    }
  }

  function saveExpandedSet(set){
    localStorage.setItem(EXP_KEY, JSON.stringify([...set]));
  }

  function toggleCard(el){
    const card = el.closest('.card');
    if (!card) return;

    const project = card.getAttribute('data-project') || '';
    const expanded = loadExpandedSet();

    card.classList.toggle('expanded');
    if (card.classList.contains('expanded')) expanded.add(project);
    else expanded.delete(project);

    saveExpandedSet(expanded);
  }
  window.toggleCard = toggleCard;

  function fmtBytes(n) {
    if (n == null) return '—';
    const units = ['B','KB','MB','GB','TB','PB'];
    let x = Number(n);
    if (!isFinite(x)) return '—';
    let i = 0;
    while (x >= 1024 && i < units.length - 1) { x /= 1024; i++; }
    const dp = i === 0 ? 0 : 1;
    return `${x.toFixed(dp)} ${units[i]}`;
  }

  function fmtPct(x) {
    if (x == null || !isFinite(Number(x))) return '—';
    return `${Number(x).toFixed(1)}%`;
  }

  function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }

  function escapeHtml(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function colorForPct(p){
    const ok = getComputedStyle(document.documentElement).getPropertyValue('--ok').trim();
    const warn = getComputedStyle(document.documentElement).getPropertyValue('--warn').trim();
    const bad = getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();
    if (p < 60) return ok;
    if (p < 85) return warn;
    return bad;
  }

  // Smaller radial gauge SVG (64x64)
  function gaugeSVG(pct, label){
    const p = clamp(Number(pct ?? 0), 0, 100);
    const r = 28;
    const cx = 32, cy = 32;
    const startAngle = -210;
    const endAngle = 30;
    const sweep = endAngle - startAngle; // 240
    const a = startAngle + (sweep * (p / 100));

    function polarToXY(angleDeg){
      const rad = (Math.PI / 180) * angleDeg;
      return [cx + r * Math.cos(rad), cy + r * Math.sin(rad)];
    }

    const [sx, sy] = polarToXY(startAngle);
    const [ex, ey] = polarToXY(endAngle);
    const [px, py] = polarToXY(a);

    const bgPath = `M ${sx} ${sy} A ${r} ${r} 0 1 1 ${ex} ${ey}`;
    const progSweep = sweep * (p/100);
    const progLarge = progSweep > 180 ? 1 : 0;
    const progPath = `M ${sx} ${sy} A ${r} ${r} 0 ${progLarge} 1 ${px} ${py}`;

    const col = colorForPct(p);
    const id = `g${Math.random().toString(16).slice(2)}`;

    return `
      <svg width="64" height="64" viewBox="0 0 64 64" aria-label="${escapeHtml(label)} gauge">
        <defs>
          <filter id="${id}" x="-40%" y="-40%" width="180%" height="180%">
            <feGaussianBlur stdDeviation="2.2" result="blur"/>
            <feColorMatrix
              in="blur"
              type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 0.55 0"
              result="glow"
            />
            <feMerge>
              <feMergeNode in="glow"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <path d="${bgPath}" stroke="rgba(255,255,255,0.10)" stroke-width="7.5" fill="none" stroke-linecap="round"/>
        <path d="${progPath}" stroke="${col}" stroke-width="7.5" fill="none" stroke-linecap="round" filter="url(#${id})"/>

        <circle cx="32" cy="34" r="18" fill="rgba(12,14,18,0.55)" stroke="rgba(255,255,255,0.06)"/>
        <text x="32" y="35" text-anchor="middle" font-size="11" fill="rgba(231,234,240,0.92)" font-weight="900">${p.toFixed(0)}%</text>
        <text x="32" y="49" text-anchor="middle" font-size="8.5" fill="rgba(168,176,192,0.92)" font-weight="800">${escapeHtml(label)}</text>
      </svg>
    `;
  }

  function statusClass(s){
    const x = String(s || '').toLowerCase();
    if (x.includes('running')) return 'running';
    if (x.includes('restart')) return 'restarting';
    return 'stopped';
  }

  function memPct(memUsage, memLimit){
    if (!memLimit || memLimit <= 0) return null;
    return clamp((memUsage / memLimit) * 100, 0, 100);
  }

  async function restartProject(project) {
    if (!confirm(`Restart stack "${project}"?\nThis restarts all containers in that compose project.`)) return;

    statusPill.textContent = `Restarting ${project}…`;
    statusPill.style.borderColor = 'rgba(255,209,102,0.35)';

    try {
      const res = await fetch(`/api/stacks/${encodeURIComponent(project)}/restart`, { method: 'POST' });
      const out = await res.json();
      if (!res.ok) throw new Error(out.detail || `HTTP ${res.status}`);

      const errCount = (out.errors || []).length;
      alert(`Restarted: ${(out.restarted || []).length} container(s)\nErrors: ${errCount}`);
    } catch (e) {
      alert(`Restart failed: ${e}`);
    } finally {
      await fetchStacks();
    }
  }
  window.restartProject = restartProject;

  async function fetchStacks() {
    statusPill.textContent = 'Loading…';
    statusPill.style.borderColor = 'rgba(255,255,255,0.10)';

    try {
      const res = await fetch('/api/stacks', { cache: 'no-store' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);

      const dt = new Date((data.updated_at || Date.now()/1000) * 1000);
      const err = data.cache_error ? ` • cache error: ${data.cache_error}` : '';
      statusPill.textContent = `Updated ${dt.toLocaleTimeString()}${err}`;

      lastStacks = data.stacks || [];
      render(lastStacks);
    } catch (e) {
      statusPill.textContent = `Error: ${e}`;
      statusPill.style.borderColor = 'rgba(255,92,122,0.45)';
      grid.innerHTML = `<div class="empty">Could not load stacks.<br/><span style="color:var(--muted)">${escapeHtml(e)}</span></div>`;
    }
  }

  function render(stacks) {
    const q = (filterEl.value || '').trim().toLowerCase();
    const filtered = stacks.filter(s => String(s.project || '').toLowerCase().includes(q));

    if (!filtered.length) {
      grid.innerHTML = `<div class="empty">No stacks match “${escapeHtml(filterEl.value || '')}”.</div>`;
      return;
    }

    const expanded = loadExpandedSet();

    grid.innerHTML = filtered.map(s => {
      const t = s.totals || {};
      const containers = s.containers || [];

      const cpu = Number(t.cpu_percent ?? 0);
      const memUsage = Number(t.mem_usage ?? 0);
      const memLimit = Number(t.mem_limit ?? 0);
      const mp = memPct(memUsage, memLimit);
      const memLine = fmtBytes(memUsage);

      const netLine = `↓ ${fmtBytes(t.net_rx)}  ↑ ${fmtBytes(t.net_tx)}`;
      const diskLine = `R ${fmtBytes(t.blk_read)}  W ${fmtBytes(t.blk_write)}`;

      const project = String(s.project || '');
      const isExpanded = expanded.has(project);

      return `
        <div class="card ${isExpanded ? 'expanded' : ''}" data-project="${escapeHtml(project)}">
          <div class="cardHeader">
            <div class="stackTitle">
              <div class="stackName">
                <strong title="${escapeHtml(project)}">${escapeHtml(project)}</strong>
                <span class="chip">${containers.length} containers</span>
              </div>
            </div>
            <div>
              <button onclick="restartProject('${escapeHtml(project)}')">Restart</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="gaugesInline">
              <div class="gaugeMini">
                ${gaugeSVG(clamp(cpu,0,100), 'CPU')}
                <div class="txt">
                  <div class="k">CPU</div>
                  <div class="v">${fmtPct(cpu)}</div>
                </div>
              </div>

              <div class="gaugeMini">
                ${gaugeSVG(mp ?? 0, 'MEM')}
                <div class="txt">
                  <div class="k">Memory</div>
                  <div class="v">${escapeHtml(memLine)}${mp != null ? ` • ${mp.toFixed(0)}%` : ''}</div>
                </div>
              </div>
            </div>

            <div class="ioGrid">
              <div class="metric">
                <div class="k">Network</div>
                <div class="v">${escapeHtml(netLine)}</div>
              </div>
              <div class="metric">
                <div class="k">Disk I/O</div>
                <div class="v">${escapeHtml(diskLine)}</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="expandToggle" onclick="toggleCard(this)">
            <span class="chevron">▸</span>
            <span>Containers (${containers.length})</span>
          </div>

          <div class="containerSection">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th class="col-service" style="width: 22%;">Service</th>
                    
                    <th class="col-status" style="width: 20%;">Status</th>
                    <th class="col-cpu right" style="width: 14%;">CPU</th>
                    <th class="col-mem right" style="width: 18%;">Mem</th>
                  </tr>
                </thead>
                <tbody>
                  ${containers.map(c => {
                    const st = c.stats;
                    const cCpu = st ? Number(st.cpu_percent ?? 0) : null;
                    const cMem = st ? Number(st.mem_usage ?? 0) : null;
                    const cLim = st ? Number(st.mem_limit ?? 0) : null;
                    const cMemLine = st
                      ? (cLim ? `${fmtBytes(cMem)} ` : fmtBytes(cMem))
                      : '—';
                    const dot = statusClass(c.status);
                    return `
                      <tr>
                        <td>${escapeHtml(c.service || '')}</td>
                        
                        <td>
                          <span class="statusDot ${dot}"></span>
                          ${escapeHtml(c.status)}
                        </td>
                        <td class="right">${st ? fmtPct(cCpu) : '—'}</td>
                        <td class="right">${escapeHtml(cMemLine)}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Filter should not refetch; just re-render cached data
  filterEl.addEventListener('input', () => render(lastStacks));
  refreshBtn.addEventListener('click', fetchStacks);

  let timer = null;
  function setAutoRefresh() {
    if (timer) clearInterval(timer);
    const sec = Number(autoRefresh.value);
    if (sec > 0) timer = setInterval(fetchStacks, sec * 1000);
  }
  autoRefresh.addEventListener('change', setAutoRefresh);

  setAutoRefresh();
  fetchStacks();
</script>
</body>
</html>
